# ===================================================================
# 기본 애플리케이션 설정 (모든 프로필에 공통)
# ===================================================================
spring:
  application:
    name: loglens
  profiles:
    #    active: ${SPRING_PROFILES_ACTIVE:dev}
    active: dev

  # ===================================================================
  # 데이터 소스 설정 (DataSource Configuration)
  # ===================================================================
  datasource:
    hikari:
      maximum-pool-size: 50          # 151 중 일부만 사용 (여유 있음)
      minimum-idle: 10               # idle 커넥션 조금 더 확보
      connection-timeout: 10000      # 10초 내 커넥션 못 얻으면 예외 발생
      idle-timeout: 600000           # 유휴 커넥션 10분 유지
      max-lifetime: 1700000          # 28분 20초 (MySQL wait_timeout보다 짧게)
      validation-timeout: 5000       # 커넥션 검증 대기 5초
      keepalive-time: 300000         # 5분마다 ping으로 커넥션 생존 확인
      leak-detection-threshold: 10000  # 10초 이상 반환 안 되면 로그 출력

  # ===================================================================
  # JPA 및 Hibernate 설정 (JPA & Hibernate Configuration)
  # ===================================================================
  jpa:
    open-in-view: false
    properties:
      hibernate:
        use_sql_comments: true
        jdbc:
          batch_size: 20
        order_inserts: true
        order_updates: true

  data:
    redis:
      host: ${SPRING_REDIS_HOST:localhost}
      port: ${SPRING_REDIS_PORT:6379}
      password: ${SPRING_REDIS_PASSWORD:}
      # Redis 연결 풀 설정 추가
      lettuce:
        pool:
          max-active: 20      # 최대 활성 연결 수
          max-idle: 10        # 최대 유휴 연결 수
          min-idle: 5         # 최소 유휴 연결 수
          max-wait: 3000ms    # 연결 대기 최대 시간
        shutdown-timeout: 200ms

server:
  port: ${SERVER_PORT:8080}
  shutdown: graceful
  # Tomcat 스레드 풀 설정
  tomcat:
    threads:
      max: 200              # 최대 워커 스레드 수
      min-spare: 10         # 최소 유휴 스레드 수
    max-connections: 10000  # 최대 동시 연결 수
    accept-count: 100       # 대기 큐 크기
    connection-timeout: 20000 # 연결 타임아웃 (20초)
    # ALB와의 연결 안정성을 위한 Keep-Alive 설정
    # ALB idle timeout: 60초, HTTP 클라이언트 keep-alive: 3600초
    keep-alive-timeout: 65000  # 65초 (ALB idle timeout 60초보다 약간 길게)
    max-keep-alive-requests: -1  # 무제한 (SSE 연결 유지를 위해 필요)

# ===================================================================
# 로깅 설정 (Logging Configuration)
# ===================================================================
logging:
  level:
    root: WARN
    org.springframework.jdbc: INFO
    org.hibernate.SQL: OFF
    org.hibernate.orm.jdbc.bind: OFF
    org.hibernate.orm.jdbc.extract: OFF
    org.hibernate.type.descriptor.sql: OFF
    org.hibernate.engine.jdbc.spi.SqlExceptionHelper: OFF
    org.hibernate.stat: OFF
    com.a306.osm.domain.notification.service.impl.SseNotificationServiceImpl: WARN

jwt:
  secret: ${JWT_SECRET:c3es6QmdhS7Bffn7u3ljFyWnj50RxsLqNzpgomVwJjZvbsdiIKkXunqexhnL7+ROLg+5Kxzf2ljrakWSPTsV6g==}
  access-token-validity-in-seconds: 1800
  refresh-token-validity-in-seconds: 604800

management:
  endpoint:
    prometheus:
      enabled: true
  endpoints:
    web:
      exposure:
        include: health, prometheus, metrics, info
  prometheus:
    metrics:
      export:
        enabled: true

llm:
  api:
    key: ${LLM_API_KEY:}

encryption:
  secret-key: ${ENCRYPTION_SECRET_KEY}

# ===================================================================
# OpenSearch 설정 (OpenSearch Configuration)
# ===================================================================
opensearch:
  scheme: https
  host: opensearch.loglens.store
  port: 443
  username: ${OPENSEARCH_USERNAME:admin}
  password: ${OPENSEARCH_PASSWORD:admin}
  # 성능 최적화 설정 추가
  max-connections: 50              # 최대 연결 수
  max-connections-per-route: 25    # 라우트당 최대 연결 수
  connection-timeout: 5000         # 연결 타임아웃 (5초)
  socket-timeout: 30000            # 소켓 타임아웃 (30초)

# ===================================================================
# AI 서비스 설정 (AI Service Configuration)
# ===================================================================
ai:
  service:
    base-url: ${AI_SERVICE_URL:https://ai.loglens.store}
    timeout: 30000                 # AI 분석 타임아웃 (30초, LLM 처리 시간 고려)

# ===================================================================
# SSE 스트리밍 설정 (SSE Streaming Configuration)
# ===================================================================
sse:
  scheduler:
    pool-size: 50                  # SSE 스케줄러 스레드 풀 크기 (동시 50개 연결 지원)
  timeout: 3600000                 # SSE 연결 타임아웃 (60분, 밀리초)
  # ALB idle timeout(60초)보다 충분히 길게 설정
  # heartbeat(5초 주기)로 연결 유지

dependency:
  logger:
    api-key: 831776ac-2d47-3e23-83b9-7619972f0cbf

    collector:
      url: https://api.loglens.co.kr
    enabled: true

    stacktrace:
      max-lines: 3

    frontend:
      enabled: true
      log-path: ./logs/fe/app.log
