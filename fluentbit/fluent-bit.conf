############################################################
#  Fluent Bit 설정 파일 (Spring Boot 백엔드 로그 수집)
############################################################

[SERVICE]
    Flush        5
    Daemon       Off
    Log_Level    info
    Parsers_File /fluent-bit/etc/parsers.conf

    # 모니터링용 HTTP 서버
    HTTP_Server  On
    HTTP_Listen  0.0.0.0
    HTTP_Port    2020

    # 환경 변수 등록
    Env          PROJECT_UUID
    Env          PROJECT_NAME


############################################################
# INPUT: 백엔드 로그만 수집
############################################################

[INPUT]
    Name              tail
    Path              /logs/be/*.log
    Tag               app.logs
    Parser            json
    Refresh_Interval  5
    Read_from_Head    true
    Skip_Long_Lines   On
    Mem_Buf_Limit     10MB
    DB                /var/log/fluentbit-be-offsets.db


############################################################
# FILTER: 로그 가공
############################################################

# JSON 파싱
[FILTER]
    Name          parser
    Match         app.logs
    Key_Name      log
    Parser        json
    Reserve_Data  On
    Preserve_Key  On

# 텍스트 로그 파싱 (JSON 아닌 경우 대비)
[FILTER]
    Name          parser
    Match         app.logs
    Key_Name      log
    Parser        spring_boot_text
    Reserve_Data  On
    Preserve_Key  On

# 프로젝트 UUID 추가
[FILTER]
    Name          record_modifier
    Match         app.logs
    Record        project_uuid ${PROJECT_UUID}
    Record        service_name ${PROJECT_NAME}

# source_type 자동 구분 (BE로 설정)
[FILTER]
    Name          lua
    Match         app.logs
    script        /fluent-bit/scripts/transform.lua
    call          transform_log

# 공통 필드 정리
[FILTER]
    Name          modify
    Match         app.logs
    Copy          level       log_level
    Copy          package     logger


############################################################
# OUTPUT: Kafka 전송
############################################################

[OUTPUT]
    Name              kafka
    Match             app.logs
    Brokers           ai.loglens.store:9092
    Topics            application-logs
    Format            json
    Timestamp_Key     timestamp
    Timestamp_Format  iso8601

    # Kafka 설정
    rdkafka.message.max.bytes             10485760    # 10MB
    rdkafka.request.required.acks       1
    rdkafka.message.timeout.ms          10000
    rdkafka.retry.backoff.ms            100
    rdkafka.socket.keepalive.enable     true
    rdkafka.log.connection.close        false
    rdkafka.batch.size                  16384
    rdkafka.batch.num.messages          1000
    rdkafka.compression.type            snappy
    rdkafka.request.timeout.ms          30000
    rdkafka.metadata.max.age.ms         180000

# 디버깅용
[OUTPUT]
    Name          stdout
    Match         app.logs
    Format        json_lines
