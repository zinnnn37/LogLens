############################################################
#  Fluent Bit ì„¤ì • íŒŒì¼ (Spring Boot + Front + Infra ë¡œê·¸ í†µí•© ìˆ˜ì§‘)
#  - ë°±ì—”ë“œ(/logs/be)ì™€ í”„ë¡ íŠ¸ì—”ë“œ(/logs/fe) ë¡œê·¸ë¥¼ ë™ì‹œì— ìˆ˜ì§‘
#  - ì‹œìŠ¤í…œ ë¡œê·¸(syslog, docker, systemd) ìˆ˜ì§‘
#  - ê³µí†µ í•„í„°ë¡œ êµ¬ì¡° í†µí•© í›„ Kafka(application-logs í† í”½)ìœ¼ë¡œ ì „ì†¡
#  - ìµœì¢…ì ìœ¼ë¡œ BE/FE/INFRAëŠ” source_type í•„ë“œë¡œ êµ¬ë¶„
############################################################

[SERVICE]
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ğŸ”§ Fluent Bit ê¸°ë³¸ ì„œë¹„ìŠ¤ ì„¤ì •
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Flush        5
    Daemon       Off
    Log_Level    info
    Parsers_File /fluent-bit/etc/parsers.conf

    # âœ… ëª¨ë‹ˆí„°ë§ìš© HTTP ì„œë²„ ì„¤ì • (ìƒíƒœ/ë©”íŠ¸ë¦­ í™•ì¸ìš©)
    HTTP_Server  On
    HTTP_Listen  0.0.0.0
    HTTP_Port    2020

    # âœ… í™˜ê²½ ë³€ìˆ˜ ë“±ë¡ (record_modifierì—ì„œ ì°¸ì¡°)
    Env          PROJECT_UUID


############################################################
# INPUT ë‹¨ê³„: ë¡œê·¸ íŒŒì¼ì„ ì½ì–´ì˜¤ëŠ” ë¶€ë¶„
############################################################

# ===========================================
# INPUT 1: ë°±ì—”ë“œ ë¡œê·¸ (/logs/be/*.log)
# ===========================================
[INPUT]
    Name              tail
    Path              /logs/be/*.log
    Tag               app.logs
    Refresh_Interval  5
    Read_from_Head    true
    Skip_Long_Lines   On
    Mem_Buf_Limit     10MB
    DB                /var/log/fluentbit-be-offsets.db

# ===========================================
# INPUT 2: í”„ë¡ íŠ¸ì—”ë“œ ë¡œê·¸ (/logs/fe/*.log)
# ===========================================
[INPUT]
    Name              tail
    Path              /logs/fe/*.log
    Tag               app.logs
    Refresh_Interval  5
    Read_from_Head    true
    Skip_Long_Lines   On
    Mem_Buf_Limit     10MB
    DB                /var/log/fluentbit-fe-offsets.db

# ===========================================
# INPUT 3: ì¸í”„ë¼ ë¡œê·¸ (/logs/infra/*.log)
# ===========================================
[INPUT]
    Name              tail
    Path              /logs/infra/*.log
    Tag               infra.logs
    Refresh_Interval  5
    Read_from_Head    true
    Skip_Long_Lines   On
    Mem_Buf_Limit     10MB
    DB                /var/log/fluentbit-infra-offsets.db

# ===========================================
# INPUT 4: Docker ì»¨í…Œì´ë„ˆ ë¡œê·¸
# ===========================================
[INPUT]
    Name              tail
    Path              /var/lib/docker/containers/*/*.log
    Tag               docker.logs
    Parser            docker
    Refresh_Interval  5
    Read_from_Head    false
    Skip_Long_Lines   On
    Mem_Buf_Limit     10MB
    DB                /var/log/fluentbit-docker-offsets.db

# ===========================================
# INPUT 5: ì‹œìŠ¤í…œ ë¡œê·¸ (syslog)
# ===========================================
[INPUT]
    Name              tail
    Path              /var/log/syslog,/var/log/messages
    Tag               system.logs
    Parser            syslog
    Refresh_Interval  5
    Read_from_Head    false
    Skip_Long_Lines   On
    Mem_Buf_Limit     5MB
    DB                /var/log/fluentbit-syslog-offsets.db

# ===========================================
# INPUT 6: systemd journal ë¡œê·¸
# ===========================================
[INPUT]
    Name              systemd
    Tag               systemd.logs
    Read_From_Tail    On
    Strip_Underscores On

# ===========================================
# INPUT 7: Nginx ì•¡ì„¸ìŠ¤ ë¡œê·¸
# ===========================================
[INPUT]
    Name              tail
    Path              /var/log/nginx/access.log
    Tag               nginx.access
    Parser            nginx
    Refresh_Interval  5
    Read_from_Head    false
    Skip_Long_Lines   On
    Mem_Buf_Limit     5MB
    DB                /var/log/fluentbit-nginx-access-offsets.db

# ===========================================
# INPUT 8: Nginx ì—ëŸ¬ ë¡œê·¸
# ===========================================
[INPUT]
    Name              tail
    Path              /var/log/nginx/error.log
    Tag               nginx.error
    Refresh_Interval  5
    Read_from_Head    false
    Skip_Long_Lines   On
    Mem_Buf_Limit     5MB
    DB                /var/log/fluentbit-nginx-error-offsets.db


############################################################
# FILTER ë‹¨ê³„: ë¡œê·¸ ê°€ê³µ ë° êµ¬ì¡° ì •ë¦¬
############################################################

# ===========================================
# FILTER 1: JSON íŒŒì‹± (ì´ë¯¸ JSON êµ¬ì¡°ì¸ ë¡œê·¸ ì²˜ë¦¬)
# ===========================================
[FILTER]
    Name          parser
    Match         app.logs
    Key_Name      log
    Parser        json
    Reserve_Data  On
    Preserve_Key  On

# ===========================================
# FILTER 2: í…ìŠ¤íŠ¸ ë¡œê·¸ íŒŒì‹± (Spring Boot í…ìŠ¤íŠ¸ ë¡œê·¸ ì²˜ë¦¬)
# ===========================================
[FILTER]
    Name          parser
    Match         app.logs
    Key_Name      log
    Parser        spring_boot_text
    Reserve_Data  On
    Preserve_Key  On

# ===========================================
# FILTER 3: ì¸í”„ë¼ ë¡œê·¸ íŒŒì‹±
# ===========================================
[FILTER]
    Name          parser
    Match         infra.logs
    Key_Name      log
    Parser        json
    Reserve_Data  On
    Preserve_Key  On

# ===========================================
# FILTER 4: ë©”íƒ€ë°ì´í„° ì¶”ê°€ (í”„ë¡œì íŠ¸ UUID)
# ===========================================
[FILTER]
    Name          record_modifier
    Match         app.logs
    Record        project_uuid ${PROJECT_UUID}

[FILTER]
    Name          record_modifier
    Match         infra.logs
    Record        project_uuid ${PROJECT_UUID}

[FILTER]
    Name          record_modifier
    Match         docker.logs
    Record        project_uuid ${PROJECT_UUID}

[FILTER]
    Name          record_modifier
    Match         system.logs
    Record        project_uuid ${PROJECT_UUID}

[FILTER]
    Name          record_modifier
    Match         systemd.logs
    Record        project_uuid ${PROJECT_UUID}

[FILTER]
    Name          record_modifier
    Match         nginx.*
    Record        project_uuid ${PROJECT_UUID}

# ===========================================
# FILTER 5: source_type ìë™ êµ¬ë¶„ (íŒŒì¼ ê²½ë¡œ ê¸°ë°˜: BE/FE/INFRA)
# ===========================================
[FILTER]
    Name          lua
    Match         app.logs
    script        /fluent-bit/scripts/transform.lua
    call          detect_source_type

[FILTER]
    Name          lua
    Match         infra.logs
    script        /fluent-bit/scripts/transform.lua
    call          detect_infra_source_type

[FILTER]
    Name          lua
    Match         docker.logs
    script        /fluent-bit/scripts/transform.lua
    call          transform_docker_log

[FILTER]
    Name          lua
    Match         system.logs
    script        /fluent-bit/scripts/transform.lua
    call          transform_system_log

[FILTER]
    Name          lua
    Match         systemd.logs
    script        /fluent-bit/scripts/transform.lua
    call          transform_systemd_log

[FILTER]
    Name          lua
    Match         nginx.access
    script        /fluent-bit/scripts/transform.lua
    call          transform_nginx_access_log

[FILTER]
    Name          lua
    Match         nginx.error
    script        /fluent-bit/scripts/transform.lua
    call          transform_nginx_error_log

# ===========================================
# FILTER 6: ê³µí†µ í•„ë“œ ì •ë¦¬
# ===========================================
[FILTER]
    Name          modify
    Match         app.logs
    Copy          level       log_level
    Copy          package     logger
    Copy          @timestamp  timestamp

# ===========================================
# FILTER 7: Lua ìŠ¤í¬ë¦½íŠ¸ ë³€í™˜ (OpenSearch ìŠ¤í‚¤ë§ˆ ë³€í™˜)
# ===========================================
[FILTER]
    Name          lua
    Match         app.logs
    script        /fluent-bit/scripts/transform.lua
    call          transform_log

# ===========================================
# FILTER 8: ëª¨ë“  ë¡œê·¸ì— í†µí•© íƒœê·¸ ì ìš©
# ===========================================
[FILTER]
    Name          rewrite_tag
    Match         infra.logs
    Rule          $source_type ^(.*)$ app.logs false

[FILTER]
    Name          rewrite_tag
    Match         docker.logs
    Rule          $source_type ^(.*)$ app.logs false

[FILTER]
    Name          rewrite_tag
    Match         system.logs
    Rule          $source_type ^(.*)$ app.logs false

[FILTER]
    Name          rewrite_tag
    Match         systemd.logs
    Rule          $source_type ^(.*)$ app.logs false

[FILTER]
    Name          rewrite_tag
    Match         nginx.*
    Rule          $source_type ^(.*)$ app.logs false


############################################################
# OUTPUT ë‹¨ê³„: ì™¸ë¶€ ì‹œìŠ¤í…œìœ¼ë¡œ ë¡œê·¸ ì „ì†¡
############################################################

# ===========================================
# OUTPUT: Kafka ì „ì†¡ (ê³µí†µ í† í”½)
# ===========================================
[OUTPUT]
    Name              kafka
    Match             app.logs
    Brokers           ai.loglens.store:9092
    Topics            application-logs
    Format            json
    Timestamp_Key     timestamp
    Timestamp_Format  iso8601

    # â”€ Kafka ê³ ê¸‰ ì„¤ì • â”€
    rdkafka.request.required.acks       1
    rdkafka.message.timeout.ms          10000
    rdkafka.retry.backoff.ms            100
    rdkafka.socket.keepalive.enable     true
    rdkafka.log.connection.close        false
    rdkafka.batch.size                  16384
    rdkafka.batch.num.messages          1000
    rdkafka.compression.type            snappy
    rdkafka.request.timeout.ms          30000
    rdkafka.metadata.max.age.ms         180000

# ===========================================
# OUTPUT: ë””ë²„ê¹…ìš© (stdout)
# ===========================================
[OUTPUT]
    Name          stdout
    Match         app.logs
    Format        json_lines
