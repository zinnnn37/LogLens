# ============================================
# GitLab CI/CD for React S3 + CloudFront
# ============================================

cache:
  paths:
    - node_modules/

stages:
  - build
  - deploy

# ============================================
# BUILD STAGE
# ============================================
build:
  stage: build
  image: node:24-alpine
  
  before_script:
    - npm ci --prefer-offline --no-audit

  script:
    - npm run build
    - echo "‚úÖ Build completed!"
    - ls -la dist/  # ÎòêÎäî build/
  
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour
  
  rules:
    - if: '$CI_COMMIT_BRANCH == "fe/develop"'
    - if: '$CI_COMMIT_BRANCH == "fe/main"'

# ============================================
# DEPLOY STAGE
# ============================================
deploy:
  stage: deploy
  image: amazon/aws-cli:latest
  dependencies:
    - build

  before_script:
    - aws configure set region "$AWS_REGION"

  script:
    - echo "üì§ Syncing to S3 bucket: $S3_BUCKET ..."
    - aws s3 sync dist/ "s3://$S3_BUCKET" --delete --cache-control "public, max-age=31536000" --exclude "index.html" --exclude "*.map"
    - echo "üìÑ Uploading index.html (no-cache)..."
    - aws s3 cp dist/index.html "s3://$S3_BUCKET/index.html" --cache-control "no-cache, no-store, must-revalidate" --content-type "text/html"
    - echo "üîÑ Invalidating CloudFront cache..."
    - aws cloudfront create-invalidation --distribution-id "$CLOUDFRONT_DISTRIBUTION_ID" --paths "/index.html"
    - echo "üéâ Deployment finished successfully!"
  
  environment:
    name: production
    url: https://www.loglens.co.kr

  rules:
    - if: '$CI_COMMIT_BRANCH == "fe/develop"'
    - if: '$CI_COMMIT_BRANCH == "fe/main"'
