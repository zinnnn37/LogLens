stages:
  - test
  - build
  - deploy

test:
  stage: test
  tags:
    - npm
  script:
    - npm ci
    - npm test
  only:
    - npm/main

build:
  stage: build
  tags:
    - npm
  script:
    - npm ci
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 day
  only:
    - npm/main

deploy_to_fe:
  stage: deploy
  tags:
    - npm
  dependencies:
    - build
  before_script:
    - git config --global user.email "ci@gitlab.com"
    - git config --global user.name "GitLab CI"
  script:
    - $token = $env:FE_DEPLOY_TOKEN
    - $feUrl = "https://oauth2:$token@lab.ssafy.com/s13-final/S13P31A306.git"
    - git clone --depth 1 --branch fe/main $feUrl fe-temp
    - New-Item -ItemType Directory -Force -Path fe-temp/static/lib
    - Copy-Item dist/index.es.js fe-temp/static/lib/loglens.esm.js
    - Copy-Item dist/index.umd.js fe-temp/static/lib/loglens.umd.js
    - Copy-Item dist/index.d.ts fe-temp/static/lib/loglens.d.ts
    - cd fe-temp
    - git add static/lib/
    - |
      $changes = git diff --staged --quiet
      if ($LASTEXITCODE -ne 0) {
        git commit -m "chore: update loglens library [skip ci]"
      }
    - git push $feUrl HEAD:fe/main
    - Write-Host "✅ fe/main 업데이트 완료!"
  only:
    - npm/main