input {
  kafka {
    bootstrap_servers => "kafka:19092"
    topics => ["application-logs"]
    codec => json
    group_id => "logstash-consumer"
    auto_offset_reset => "earliest"
    consumer_threads => 3
    decorate_events => true
  }
}

filter {
  # ===================================
  # Kafka 메타데이터 정리
  # ===================================
  mutate {
    remove_field => ["@version", "event", "host"]
  }

  # ===================================
  # timestamp 필드 생성 (ISO 8601 형식)
  # ===================================
  ruby {
    code => '
      ts = event.get("@timestamp")
      if ts
        event.set("timestamp", ts.to_iso8601)
      else
        now = Time.now
        event.set("@timestamp", now)
        event.set("timestamp", now.utc.iso8601)
      end
    '
  }

  # ===================================
  # 완전 고유한 document_id 생성
  # ===================================
  ruby {
    code => '
      require "securerandom"
      require "digest"
      unique_str = "#{Time.now.utc.iso8601(6)}_#{SecureRandom.uuid}_#{event.get("trace_id")}_#{event.get("logger")}"
      event.set("[@metadata][doc_id]", Digest::SHA256.hexdigest(unique_str))
    '
  }

  # ===================================
  # log_id 생성 (검색용)
  # ===================================
  ruby {
    code => '
      require "securerandom"
      require "digest"
      unique_id = SecureRandom.uuid
      fingerprint_input = "#{event.get("@timestamp")}_#{event.get("trace_id")}_#{event.get("logger")}_#{event.get("message")}_#{unique_id}"
      event.set("[@metadata][temp_id]", Digest::SHA256.hexdigest(fingerprint_input))
    '
  }

  ruby {
    code => '
      temp_id = event.get("[@metadata][temp_id]")
      if temp_id
        log_id = temp_id[0..7].to_i(16)
        event.set("log_id", log_id)
      end
    '
  }

  # ===================================
  # project_uuid 처리 및 안전한 인덱스용 필드 생성
  # ===================================
  if ![project_uuid] or [project_uuid] == "" {
    mutate {
      add_field => { "project_uuid" => "default_project" }
    }
  }

  ruby {
    code => '
      if event.get("project_uuid")
        safe_uuid = event.get("project_uuid").gsub("-", "_")
        event.set("safe_project_uuid", safe_uuid)
      else
        event.set("safe_project_uuid", "default_project")
      end
    '
  }

  # ===================================
  # service_name 기본값
  # ===================================
  if ![service_name] or [service_name] == "" {
    mutate {
      add_field => { "service_name" => "unknown_service" }
    }
  }

  # ===================================
  # log_level & level 정규화
  # ===================================
  if [log_level] {
    mutate { uppercase => ["log_level"] }
    if [log_level] not in ["ERROR", "WARN", "INFO"] {
      mutate { replace => { "log_level" => "INFO" } }
    }
  } else {
    mutate { add_field => { "log_level" => "INFO" } }
  }

  mutate { copy => { "log_level" => "level" } }

  # ===================================
  # source_type 정규화
  # ===================================
  if ![source_type] or [source_type] not in ["FE", "BE", "INFRA"] {
    mutate { replace => { "source_type" => "BE" } }
  }

  # ===================================
  # layer 정규화
  # ===================================
  if [layer] and [layer] not in ["Controller", "Service", "Repository", "Filter", "Util", "Other"] {
    mutate { remove_field => ["layer"] }
  }

  # ===================================
  # trace_id 기본값
  # ===================================
  if ![trace_id] or [trace_id] == "" {
    mutate { add_field => { "trace_id" => "unknown" } }
  }

  # ===================================
  # 타입 변환
  # ===================================
  if [duration] {
    mutate { convert => { "duration" => "integer" } }
  }

  if [log_details][execution_time] {
    mutate { convert => { "[log_details][execution_time]" => "integer" } }
  }

  if [log_details][response_status] {
    mutate { convert => { "[log_details][response_status]" => "integer" } }
  }

  # ===================================
  # indexed_at 추가
  # ===================================
  ruby {
    code => 'event.set("indexed_at", Time.now.utc.strftime("%Y-%m-%dT%H:%M:%S.%LZ"))'
  }

  # ===================================
  # response_body 문자열화 (mapping conflict 방지)
  # ===================================
  if [log_details][response_body] {
    ruby {
      code => '
        response_body = event.get("[log_details][response_body]")
        if response_body
          if response_body.is_a?(Hash) || response_body.is_a?(Array)
            event.set("[log_details][response_body]", response_body.to_json)
          else
            event.set("[log_details][response_body]", response_body.to_s)
          end
        end
      '
    }
  }

  # ===================================
  # 불필요한 필드 제거
  # ===================================
  mutate {
    remove_field => [
      "log",
      "@version",
      "package",
      "app_name",
      "pid",
      "thread",
      "hostname",
      "file"
    ]
  }
}

output {
  # ===================================
  # OpenSearch 출력 (project_uuid + YYYY_MM)
  # ===================================
  opensearch {
    hosts => ["http://opensearch:9200"]
    index => "%{safe_project_uuid}_%{+YYYY_MM}"  # ← 전부 언더스코어 기반으로 변경
    document_id => "%{[@metadata][doc_id]}"
    action => "create"
    retry_on_conflict => 3
  }

  # ===================================
  # 디버깅용 출력
  # ===================================
  stdout {
    codec => rubydebug { metadata => true }
  }
}
