input {
  kafka {
    bootstrap_servers => "kafka:19092"
    topics => ["application-logs"]
    codec => json
    group_id => "logstash-consumer"
    auto_offset_reset => "earliest"
    consumer_threads => 3
    decorate_events => true
  }
}

filter {
  # Kafka 메타데이터 제거 (선택사항)
  mutate {
    remove_field => ["@version", "event"]
  }

  # timestamp 필드가 있으면 @timestamp로 사용
  if [timestamp] {
    date {
      match => ["timestamp", "ISO8601"]
      target => "@timestamp"
    }
  }

  # log_id가 있으면 document ID로 사용 (중복 방지)
  if [log_id] {
    mutate {
      add_field => { "[@metadata][doc_id]" => "%{log_id}" }
    }
  }
}

output {
  opensearch {
    hosts => ["https://opensearch:9200"]
    index => "logs-%{+YYYY.MM}"
    user => "admin"
    password => "Admin123!@#"
    ssl => true
    ssl_certificate_verification => false

    # log_id를 document ID로 사용 (중복 방지)
    document_id => "%{[@metadata][doc_id]}"

    # 실패 시 재시도
    retry_on_conflict => 3
  }

  # 디버깅용 출력 (선택사항, 프로덕션에서는 제거 권장)
  # stdout {
  #   codec => rubydebug {
  #     metadata => true
  #   }
  # }
}
