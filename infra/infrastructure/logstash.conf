input {
  kafka {
    bootstrap_servers => "kafka:19092"
    topics => ["application-logs"]
    codec => json
    group_id => "logstash-consumer"
    auto_offset_reset => "earliest"
    consumer_threads => 3
    decorate_events => true
  }
}

filter {
  # ===================================
  # Kafka 메타데이터 정리
  # ===================================
  mutate {
    remove_field => ["@version", "event", "host"]
  }

  # ===================================
  # timestamp 필드 처리 → @timestamp
  # ===================================
  if [timestamp] {
    date {
      match => [
        "timestamp",
        "ISO8601",
        "yyyy-MM-dd'T'HH:mm:ss.SSSZ",
        "yyyy-MM-dd'T'HH:mm:ss.SSSSSSZ"
      ]
      target => "@timestamp"
      timezone => "UTC"
    }
  }

  # ===================================
  # log_id 생성 (고유 ID)
  # ===================================
  fingerprint {
    source => ["@timestamp", "trace_id", "logger", "message"]
    target => "[@metadata][doc_id]"
    method => "SHA256"
  }

  # SHA256 해시를 숫자로 변환 (log_id)
  ruby {
    code => '
      doc_id = event.get("[@metadata][doc_id]")
      if doc_id
        # SHA256 해시의 첫 16자를 16진수로 변환하여 long 타입으로 사용
        log_id = doc_id[0..15].to_i(16)
        event.set("log_id", log_id)
      end
    '
  }

  # ===================================
  # project_uuid 처리 (필수, 기본값 설정)
  # ===================================
  if ![project_uuid] or [project_uuid] == "" {
    mutate {
      add_field => { "project_uuid" => "default-project" }
    }
  }

  # ===================================
  # service_name 처리 (필수, 기본값 설정)
  # ===================================
  if ![service_name] or [service_name] == "" {
    mutate {
      add_field => { "service_name" => "unknown-service" }
    }
  }

  # ===================================
  # log_level & level 정규화 (필수: INFO, WARN, ERROR)
  # ===================================
  if [log_level] {
    mutate {
      uppercase => ["log_level"]
    }
    if [log_level] not in ["ERROR", "WARN", "INFO"] {
      mutate {
        replace => { "log_level" => "INFO" }
      }
    }
  } else {
    mutate {
      add_field => { "log_level" => "INFO" }
    }
  }

  # level 필드 동기화 (AI 코드 호환성)
  mutate {
    copy => { "log_level" => "level" }
  }

  # ===================================
  # source_type 정규화 (FE, BE, INFRA)
  # ===================================
  if ![source_type] or [source_type] not in ["FE", "BE", "INFRA"] {
    mutate {
      replace => { "source_type" => "BE" }
    }
  }

  # ===================================
  # layer 정규화 (Controller, Service, Repository, Filter, Util, Other)
  # ===================================
  if [layer] and [layer] not in ["Controller", "Service", "Repository", "Filter", "Util", "Other"] {
    mutate {
      remove_field => ["layer"]
    }
  }

  # ===================================
  # trace_id 기본값 설정
  # ===================================
  if ![trace_id] or [trace_id] == "" {
    mutate {
      add_field => { "trace_id" => "unknown" }
    }
  }

  # ===================================
  # 필드 타입 변환
  # ===================================
  if [duration] {
    mutate {
      convert => { "duration" => "integer" }
    }
  }

  if [log_details][execution_time] {
    mutate {
      convert => { "[log_details][execution_time]" => "integer" }
    }
  }

  if [log_details][response_status] {
    mutate {
      convert => { "[log_details][response_status]" => "integer" }
    }
  }

  # ===================================
  # indexed_at 타임스탬프 추가
  # ===================================
  ruby {
    code => 'event.set("indexed_at", Time.now.utc.strftime("%Y-%m-%dT%H:%M:%S.%LZ"))'
  }

  # ===================================
  # 불필요한 필드 제거
  # ===================================
  mutate {
    remove_field => [
      "log",
      "@version",
      "package",
      "app_name",
      "pid",
      "thread",
      "hostname",
      "file"
    ]
  }
}

output {
  # ===================================
  # OpenSearch 출력
  # ===================================
  opensearch {
    hosts => ["http://opensearch:9200"]
    index => "logs-%{+YYYY.MM}"

    # Document ID 설정 (중복 방지)
    document_id => "%{[@metadata][doc_id]}"

    # 실패 시 재시도
    retry_on_conflict => 3

    # 보안 설정이 비활성화되어 있으므로 인증 불필요
    # user => "admin"
    # password => "Admin123!@#"
    # ssl => false
  }

  # ===================================
  # 디버깅용 출력 (개발 환경에서만 활성화)
  # ===================================
  # stdout {
  #   codec => rubydebug {
  #     metadata => true
  #   }
  # }
}
