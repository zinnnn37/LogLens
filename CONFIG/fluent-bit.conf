############################################################
#  Fluent Bit 설정 파일 (Spring Boot 백엔드 로그 수집)
############################################################

[SERVICE]
    Flush        5
    Daemon       Off
    Log_Level    info
    Parsers_File /fluent-bit/etc/parsers.conf

    # 모니터링용 HTTP 서버
    HTTP_Server  On
    HTTP_Listen  0.0.0.0
    HTTP_Port    2020

    # 환경 변수 등록
    Env          PROJECT_UUID
    Env          PROJECT_NAME


############################################################
# INPUT: 백엔드 로그 수집 (다중 환경 지원)
############################################################

# Docker Container 환경: Docker logging driver (fluentd)로 전송된 로그 수신
[INPUT]
    Name              forward
    Listen            0.0.0.0
    Port              24224
    Tag               app.logs
    Buffer_Chunk_Size 1M
    Buffer_Max_Size   6M

# EC2 Bare Metal 환경: 파일 기반 로그 수집
[INPUT]
    Name              tail
    Path              /logs/be/*.log
    Tag               app.logs
    Parser            json
    Refresh_Interval  5
    Read_from_Head    true
    Skip_Long_Lines   On
    Mem_Buf_Limit     10MB
    DB                /var/log/fluentbit-be-offsets.db

# ================================================
# EC2 Bare Metal 환경: 프론트엔드 로그 수집
# ================================================
[INPUT]
    Name              tail
    Path              /logs/fe/*.log
    Tag               app.logs
    Parser            json
    Refresh_Interval  5
    Read_from_Head    true
    Skip_Long_Lines   On
    Mem_Buf_Limit     10MB
    DB                /var/log/fluentbit-fe-offsets.db

############################################################
# INPUT: MySQL 로그 수집
############################################################

# Error Log
[INPUT]
    Name              tail
    Path              /logs/infra/mysql/error.log
    Tag               infra.mysql.error
    Parser            mysql_error
    Refresh_Interval  5
    Read_from_Head    false
    Skip_Long_Lines   On
    Mem_Buf_Limit     5MB
    DB                /var/log/fluentbit-mysql-error-offsets.db

# Slow Query Log (멀티라인)
[INPUT]
    Name              tail
    Path              /logs/infra/mysql/slow.log
    Tag               infra.mysql.slow
    Refresh_Interval  5
    Read_from_Head    false
    Skip_Long_Lines   On
    Mem_Buf_Limit     5MB
    DB                /var/log/fluentbit-mysql-slow-offsets.db
    Multiline         On
    Parser_Firstline  mysql_slow_firstline
    Parser_1          mysql_slow_body

############################################################
# FILTER: 로그 가공
############################################################

# 1단계: 기본 JSON 파싱 (log 필드를 JSON으로 파싱)
[FILTER]
    Name          parser
    Match         app.logs
    Key_Name      log
    Parser        json
    Reserve_Data  On
    Preserve_Key  Off

# 2단계: 텍스트 로그 대비 파싱 (JSON 파싱 실패 시)
[FILTER]
    Name          parser
    Match         app.logs
    Key_Name      log
    Parser        spring_boot_text
    Reserve_Data  On
    Preserve_Key  Off

# 3단계: message 필드가 JSON 문자열이면 다시 파싱
[FILTER]
    Name          parser
    Match         app.logs
    Key_Name      message
    Parser        json
    Reserve_Data  On
    Preserve_Key  On

# 프로젝트 UUID 추가
[FILTER]
    Name          record_modifier
    Match         app.logs
    Record        project_uuid ${PROJECT_UUID}
    Record        service_name ${PROJECT_NAME}

# Lua 변환
[FILTER]
    Name          lua
    Match         app.logs
    script        /fluent-bit/scripts/transform.lua
    call          transform_log

############################################################
# FILTER: MySQL 로그 메타데이터 추가
############################################################

# MySQL 로그 공통 메타데이터
[FILTER]
    Name          record_modifier
    Match         infra.mysql.*
    Record        project_uuid ${PROJECT_UUID}
    Record        service_name ${PROJECT_NAME}
    Record        source_type INFRA
    Record        component_name MySQL
    Record        layer Infra

# Error Log 레벨 설정
[FILTER]
    Name          modify
    Match         infra.mysql.error
    Add           level ERROR
    Add           log_level ERROR

# Slow Query Log 레벨 설정
[FILTER]
    Name          modify
    Match         infra.mysql.slow
    Add           level WARN
    Add           log_level WARN

# Lua 변환 적용
[FILTER]
    Name          lua
    Match         infra.mysql.*
    script        /fluent-bit/scripts/transform.lua
    call          transform_log

############################################################
# FILTER: trace_id 필터링 (app.logs만 적용)
############################################################
[FILTER]
    Name     grep
    Match    app.logs          # ← app.logs만 필터링
    Exclude  trace_id ^unknown$ # ← trace_id가 "unknown"인 로그 제외

############################################################
# FILTER: 불필요한 로그 제외
############################################################

# 1. HealthCheckController 제외
[FILTER]
    Name     grep
    Match    app.logs
    Exclude  component_name HealthCheckController

# 2. LogTrace 제외
[FILTER]
    Name     grep
    Match    app.logs
    Exclude  component_name LogTrace

# 3. 알림 관련 스케줄러 로그 제외
[FILTER]
    Name     grep
    Match    app.logs
    Exclude  component_name ^(AlertHistoryRepository|AlertConfigRepository|AlertMonitoringScheduler|AlertMonitoringServiceImpl)$

[FILTER]
    Name     grep
    Match    app.logs
    Exclude  thread_name ^sse-scheduler


############################################################
# OUTPUT: Kafka 전송
############################################################

[OUTPUT]
    Name              kafka
    Match             *
    Brokers           ai.loglens.store:9092
    Topics            application-logs
    Format            json
    Timestamp_Key     timestamp
    Timestamp_Format  iso8601

    # Kafka 설정
    rdkafka.message.max.bytes             10485760    # 10MB
    rdkafka.request.required.acks       1
    rdkafka.message.timeout.ms          10000
    rdkafka.retry.backoff.ms            100
    rdkafka.socket.keepalive.enable     true
    rdkafka.log.connection.close        false
    rdkafka.batch.size                  16384
    rdkafka.batch.num.messages          1000
    rdkafka.compression.type            snappy
    rdkafka.request.timeout.ms          30000
    rdkafka.metadata.max.age.ms         180000

# 디버깅용
[OUTPUT]
    Name          stdout
    Match         *
    Format        json_lines
